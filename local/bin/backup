#!/bin/sh -efE

BACKUP_ROOT="$HOME/downloads/linux/kissllm/chroot-x86_64"

if [ "${HOSTNAME}" = "kiss" ]; then
    KISS_ROOT=""
else
    KISS_ROOT="/mnt/kiss"
    if [ "$(/usr/bin/whoami)" = "root" ]; then
        /mnt/load-kiss
    else
        doas /mnt/load-kiss
    fi
fi

if [ "$(/usr/bin/whoami)" = "root" ]; then
    copy="rsync -aqz"
else
    copy="doas rsync -aqz"
fi

[ -d "${BACKUP_ROOT}" ] || \mkdir -p "${BACKUP_ROOT}"
[ -d "${BACKUP_ROOT}/boot" ] || \mkdir -p "${BACKUP_ROOT}/boot"

if ! eval '$copy "${KISS_ROOT}/boot" "${BACKUP_ROOT}/"'; then
    echo "Failed to copy '${KISS_ROOT}/boot'"
    exit 1
else
    echo "Succeeded in copying '${KISS_ROOT}/boot'"
fi

[ -d "${BACKUP_ROOT}/etc" ] || \mkdir -p "${BACKUP_ROOT}/etc"

if ! eval '$copy "${KISS_ROOT}/etc" "${BACKUP_ROOT}/"'; then
    echo "Failed to copy '${KISS_ROOT}/etc'"
    exit 1
else
    echo "Succeeded in copying '${KISS_ROOT}/etc'"
fi

[ -d "${BACKUP_ROOT}/usr" ] || \mkdir -p "${BACKUP_ROOT}/usr"

cd  "${KISS_ROOT}/usr"
for dir in $(doas \ls -1 "${KISS_ROOT}/usr"); do
    [ ! -d "$dir" ] || [ "$dir" = "src" ] || {
        if ! eval '$copy "${KISS_ROOT}/usr/$dir" "${BACKUP_ROOT}/usr/"'; then
            echo "Failed to copy '${KISS_ROOT}/usr/$dir'"
            exit 1
        else
            echo "Succeeded in copying '${KISS_ROOT}/usr/$dir'"
        fi
    }
done

[ -d "${BACKUP_ROOT}/var/db/kiss/installed" ] || \mkdir -p "${BACKUP_ROOT}/var/db/kiss/installed"

if ! eval '$copy "${KISS_ROOT}/var/db/kiss/installed" "${BACKUP_ROOT}/var/db/kiss/"'; then
    echo "Failed to copy '${KISS_ROOT}/var/db/kiss/installed'"
    exit 1
else
    echo "Succeeded in copying '${KISS_ROOT}/var/db/kiss/installed'"
fi

sync

echo "\$BACKUP_ROOT = '${BACKUP_ROOT}'"
echo "\$KISS_ROOT   = '${KISS_ROOT}'"
