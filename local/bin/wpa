#!/bin/sh

[ -z "$1" ] && {
    [ $(id -u) -ne 0 ] || { echo "We don't save hardcoded config files in root user's folder"; exit 1; }
    config="$1"
    [ -n "$1" ] ||
    config=$HOME/.config/wpa_supplicant/wpa_supplicant.conf
    echo "\$config = $config"
    [ -f "$config" ] ||
    { echo "Input valid \$1 for switch, please"; exit 1; }


    interface=$(\ls /sys/class/ieee80211/*/device/net)

    [ -n "$interface" ] || interface=$(iw dev | awk '$1=="Interface"{print $2}')
    echo "\$interface = $interface"
    wpa_list="$(ps -ef | grep wpa_supplicant | grep -v grep | awk "{print \$1}" | tr -d ' ')"
    for wpa in $wpa_list; do doas kill -9 $wpa; done

# https://www.linuxquestions.org/questions/slackware-14/wpa_supplicant-failed-to-initialize-driver-4175668012/
# bring up the ethernet adapter
    doas /sbin/ip link set dev $interface up >> $HOME/.config/wpa_supplicant/.wpa.log 2>&1

# flush its configuration
    doas /sbin/ip address flush dev $interface >> $HOME/.config/wpa_supplicant/.wpa.log 2>&1

# you might need an IP address before doing the IEEE 802.1X authentication with wpa_supplicant
# /sbin/dhclient eth0
    doas su dhcpcd /sbin/dhcpcd $interface >> $HOME/.config/wpa_supplicant/.wpa.log 2>&1

    doas touch /tmp/wpa.lock
# then run wpa_supplicant
# doas wpa_supplicant -D nl80211 -B -i $interface -c $HOME/.config/wpa_supplicant/wpa_supplicant.conf
    doas wpa_supplicant -D nl80211 -i $interface -c $config > $HOME/.config/wpa_supplicant/.wpa.log 2>&1 &
    sleep 3s
    doas su dhcpcd /sbin/dhcpcd $interface >> $HOME/.config/wpa_supplicant/.wpa.log 2>&1
} || {
    wpa_list="$(ps -ef | grep wpa_supplicant | grep -v grep | awk "{print \$1}" | tr -d ' ')"
    for wpa in $wpa_list; do doas kill -9 $wpa; done
    # doas /usr/bin/find /sys/class/ -name enp2s0
    # /sys/class/net/enp2s0
    interface="enp2s0"
    doas sv restart dhcpcd
    doas /sbin/ip link set dev "$interface" up
    doas /sbin/ip address flush dev "$interface"
    doas su dhcpcd /sbin/dhcpcd "$interface"
}
