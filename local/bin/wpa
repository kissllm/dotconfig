#!/bin/sh

[ $(id -u) -ne 0 ] || { echo "We don't save hardcoded config files in root user's folder"; exit 1; }
config="$1"
[ ! -z "$1" ] ||
config=$HOME/.config/wpa_supplicant/wpa_supplicant.conf
echo "\$config = $config"
[ -f "$config" ] ||
{ echo "Input valid \$1 for switch, please"; exit 1; }
interface=$(\ls /sys/class/ieee80211/*/device/net)
[ ! -z "$interface" ] || interface=$(iw dev | awk '$1=="Interface"{print $2}')
echo "\$interface = $interface"
wpa_list="$(ps -e | grep wpa_supplicant|grep conf | cut -d ' ' -f 1)"
for wpa in $wpa_list; do doas kill -9 $wpa; done

# https://www.linuxquestions.org/questions/slackware-14/wpa_supplicant-failed-to-initialize-driver-4175668012/
# bring up the ethernet adapter
doas /sbin/ip link set dev $interface up

# flush its configuration
doas /sbin/ip address flush dev $interface

# you might need an IP address before doing the IEEE 802.1X authentication with wpa_supplicant
# /sbin/dhclient eth0
doas su dhcpcd /sbin/dhcpcd $interface

# then run wpa_supplicant
# doas wpa_supplicant -D nl80211 -B -i $interface -c $HOME/.config/wpa_supplicant/wpa_supplicant.conf
doas wpa_supplicant -D nl80211 -i $interface -c $config > $HOME/.config/wpa_supplicant/.wpa.log &
sleep 3s
doas su dhcpcd /sbin/dhcpcd $interface
